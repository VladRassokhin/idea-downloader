<project name="idea-downloader-idea-patch" default="update-idea-patch" basedir=".">
    <import file="build.idea.common.xml"/>

    <target name="update-idea-patch" unless="idea-fetch-only">
        <antcall target="update-idea-patch-impl"/>
    </target>

    <target name="update-idea-patch-impl"  depends="idea-properties, update-idea-patch-settings"/>







    <target name="update-idea-patch-settings-win" if="idea-for-win">
        <copy file="${idea-unpack}/bin/idea64.exe.vmoptions" tofile="${idea-unpack}/bin/${idea-vmo}" overwrite="true"/>
    </target>

    <target name="update-idea-patch-settings-mac" if="idea-for-mac">

    </target>
    <target name="update-idea-patch-settings" depends="idea-properties,
                                                       update-idea-patch-settings-mac,
                                                       update-idea-patch-settings-win,
                                                       update-idea-patch-vmo,
                                                       update-idea-patch-plist,
                                                       update-idea-patch-props"/>

    <target name="update-idea-patch-vmo">
        <property name="opts" value="${idea-unpack}/bin/${idea-vmo}"/>

        <replaceregexp file="${opts}" match="-Xmx\d+m" replace="-Xmx1424m" flags="g" byline="true"/>
        <replaceregexp file="${opts}" match="-Xms\d+m" replace="-Xms512m" flags="g" byline="true"/>
        <replaceregexp file="${opts}" match="-XX:\+HeapDumpOnOutOfMemoryError" replace="" flags="g" byline="true" />
        <replaceregexp file="${opts}" match="-XX:ReservedCodeCacheSize=\d+m" replace="" flags="g" byline="true" />
        <replaceregexp file="${opts}" match="-XX:MaxPermSize=\d+m" replace="-XX:MaxPermSize=400m" flags="g" byline="true"/>

        <concat destfile="${opts}" append="true">
            -XX:+HeapDumpOnOutOfMemoryError
            -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=${idea-debug-port}
            -XX:+UseCompressedOops
            -XX:ReservedCodeCacheSize=228m
        </concat>
    </target>

    <target name="update-idea-patch-plist" if="idea-for-mac">
        <replaceregexp file="${idea-unpack}/Contents/Info.plist" match="-agentlib:yjp[^\s]+" replace="" flags="g" byline="true"/>
        <replaceregexp file="${idea-unpack}/Contents/Info.plist" match="&lt;string&gt;1.6\*&lt;/string&gt;" replace="&lt;string&gt;1.7*&lt;/string&gt;" flags="g" byline="true"/>
    </target>

    <target name="update-idea-patch-props">
        <property name="props" value="${idea-unpack}/bin/idea.properties"/>

        <replaceregexp file="${props}" match="idea\.dynamic\.classpath=.*" replace="idea.dynamic.classpath=true" flags="g" byline="true"/>
        <concat destfile="${props}" append="true">
            ## patched by jonnyzzz

            idea.config.path=${idea-data}/config
            idea.system.path=${idea-data}/system
            idea.plugins.path=${idea-data}/plugins
            idea.log.path=${idea-data}/logs
        </concat>
    </target>



</project>